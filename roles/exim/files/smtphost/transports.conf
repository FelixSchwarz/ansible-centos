######################################################################
#                       ORDER DOES NOT MATTER                        #
#     Only one appropriate transport is called for each delivery.    #
######################################################################

# A transport is used only when referenced from a router that successfully
# handles an address.

remote_smtp:
  driver = smtp
  dkim_selector = x
  # if
  #   (submitted from local system OR user is authenticated)
  #   AND
  #   /etc/exim/dkim/[sender domain].key exists
  #
  #   !def:sender_host_address    sender_host_address is empty for localhost => 'def:...' returns False
  #   def:authenticated_id        authenticated_id is empty for anonymous sending => 'def:...' as above
  #
  # "dkim_private_key = false" means sending unsigned mails ("just skip DKIM")
  # As per Exim spec this is not considered a signature "failure" so it works
  # even with "dkim_strict = true"
  dkim_domain = ${lc:${domain:$h_from:}}
  dkim_private_key = ${if \
    and { \ 
      { or { {!def:sender_host_address}{def:authenticated_id} } } \
      { exists{/etc/exim/dkim/${dkim_domain}_${dkim_selector}.key} } \
    } \
    {/etc/exim/dkim/${dkim_domain}_${dkim_selector}.key}{false} \
  }
  # if message signing fails, defer message delivery
  dkim_strict = true


dovecot:
  driver = pipe
  # -e will prevent rejection mails from dovecot, let Exim do that instead!
  command = /usr/libexec/dovecot/dovecot-lda \
    -a $original_local_part@$original_domain \
    -d $local_part@$domain \
    -f $sender_address \
    -e
  message_prefix =
  message_suffix =
  delivery_date_add
  envelope_to_add
  return_path_add
  log_output
  # dovecot-lda wants to read /var/run/dovecot/auth-userdb
  # which is only readable for the "mail" user.
  user = mail
  temp_errors = 64 : 69 : 70: 71 : 72 : 73 : 74 : 75 : 78

